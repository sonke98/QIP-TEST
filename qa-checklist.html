<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QIP Checklist</title>

<style>
* {
    box-sizing: border-box;
    max-width: 100%;
    word-wrap: break-word;
}

body {
    background: #f4f6f9;
    font-family: "Helvetica", Arial, sans-serif;
    font-size: 12px;
    margin: 0;
    padding: 20px;
}

h2 { text-align: center; }

/* ===== QUESTION ===== */
.question {
    background: #fff;
    padding: 5px;
    border-radius: 6px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.question h3 {
    font-size: 13px;
    margin-bottom: 6px;
}
textarea {
    width: 100%;
    min-height: 80px;
    padding: 10px;
    font-family: inherit;
}
.options label {
    display: block;
    margin: 5px 0;
}

/* ===== BUTTON ===== */
button {
    display: block;
    margin: 20px auto;
    padding: 10px 25px;
    font-size: 16px;
    background: #007bff;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

/* ===== TITLE ===== */
.title-quiz table {
    width: 190mm;
    border-collapse: collapse;
}
.title-quiz th,
.title-quiz td {
    border: 1px solid #000;
    padding: 5px 10px;
}

/* ===== PDF AREA ===== */
#pdf-area {
    width: 210mm;
    padding: 10mm;
    background: #fff;
    margin: auto;
}

/* ===== PRINT ===== */
@media print {
    body { background: #fff; margin: 0; padding: 0; }
    button, #result { display: none !important; }
    .question, table {
        page-break-inside: avoid;
        box-shadow: none !important;
        border-radius: 0 !important;
    }
}
textarea
{
    min-height: 107px;
}
</style>
</head>

<body>

<div id="pdf-area">
<div class="title-quiz">
<table width="100%">
    <tr>
        <th colspan="4">
            <h2 id="name-test">BÀI KIỂM TRA TRẮC NGHIỆM QIP CHECKLIST</h2>
        </th>
    </tr>
    <tr>
        <td colspan="2"><b>Họ và tên:</b> <input style="border: none;" type="text" placeholder="Nhập họ tên......................" id="fullname"></td>
        <td style="text-align:center;font-weight:bold;">Điểm Mark</td>
        <td style="text-align:center;font-weight:bold;"> Ghi chú Mark</td>
    </tr>
    <tr>
        <td colspan="2"><b>Số thẻ / ID: </b><input style="border: none;" type="text" placeholder="Nhập số thẻ..................." id="empid"></td>
        <td rowspan="3" id="scoreCell" style="text-align:center;font-weight:bold;"></td>
        <td rowspan="3" id="resultCell" style="text-align:center;font-weight:bold;"></td>
    </tr>
    <tr>
        <td colspan="2" id="current-date"><b>Ngày Date: </b></td>
    </tr>
    <tr>
        <td colspan="2"><b>Thời gian Time: </b>30 Phút</td>
    </tr>
</table>
</div>

<div id="quiz"></div>
<hr style="height:2px; background-color:black">
</div>
<h5 style="text-align: center;"><i>(Ghi chú) Dưới 70 điểm là không đạt)</i></h5>
<p style="text-align: center;"><i>Chi tiết thắc mắc liên hệ Bella phòng chất lượng để được hỗ trợ</i></p>
<button onclick="submitQuiz()">Nộp bài</button>
<div id="result"></div>
<script>
let db;

function openDB() {
    const request = indexedDB.open("QIP_Quiz_DB", 1);

    request.onupgradeneeded = function (e) {
        db = e.target.result;
        db.createObjectStore("results", {
            keyPath: "id",
            autoIncrement: true
        });
    };

    request.onsuccess = function (e) {
        db = e.target.result;
        console.log("IndexedDB ready");
    };

    request.onerror = function () {
        alert("Không mở được IndexedDB");
    };
}

openDB();
</script>
<script>
    // 1. Lấy đối tượng ngày giờ hiện tại
    const today = new Date();

    // 2. Lấy các thành phần ngày tháng
    const day = today.getDate(); // Ngày (1-31)
    const month = today.getMonth() + 1; // Tháng (0-11, cộng 1 để ra 1-12)
    const year = today.getFullYear(); // Năm (4 chữ số)

    // 3. (Tùy chọn) Lấy tên ngày trong tuần
    const days = ["Chủ nhật", "Thứ hai", "Thứ ba", "Thứ tư", "Thứ năm", "Thứ sáu", "Thứ bảy"];
    const dayOfWeek = days[today.getDay()];

    // 4. Định dạng ngày tháng (ví dụ: 20/01/2026)
    // Thêm số 0 ở đầu nếu ngày hoặc tháng < 10 (ví dụ: 01, 02)
    const formattedDay = day < 10 ? '0' + day : day;
    const formattedMonth = month < 10 ? '0' + month : month;
    const formattedDate = `${formattedDay}/${formattedMonth}/${year}`; // Dùng template literals

    // 5. Gán ngày tháng đã định dạng vào phần tử HTML có id="current-date"
    document.getElementById("current-date").innerHTML =  `<b>Ngày Date: </b> ${dayOfWeek}, ${formattedDate}`;
/* ====== DATA (GIỮ NGUYÊN) ====== */
const quizData = [
    // {
    //     type: "text",
    //     question: "Checklist của Deckers QIP Audit gồm những phần nào? (10 điểm)",
    //     keywords: ["kiểm tra", "chất lượng", "sản xuất"],  // dùng nếu chấm tự động
    //     score: 10
    // },
    {
        type: "choice",
        question: "QIP Checklist bao gồm những hạng mục đánh giá chính nào? (10 điểm)",
        options: { 
            a: "Cấu trúc tổ chức QIP", 
            b: "Kiểm soát chất lượng vật tư và quản lý", 
            c: "Kiểm soát chất lượng trên chuyền", 
            d: "Yêu cầu chất lượng và cải tiến",
            e: "Phòng kiểm hàng và quản lý kho",
            f: "Tất cả đều đúng"
        },
        correct: "f",
        score: 10
    },
    {
        type: "choice",
        question: "Qui trình kiểm toán QIP nội bộ được thực hiện như thế nào? (10 điểm)",
        options: { 
            a: "Thực hiện 2 lần trên tháng", 
            b: "Đánh giá chất lượng sản xuất trên chuyền", 
            c: "Kiểm tra khả năng đánh giá của TQC/RQC", 
            d: "Tất cả đều đúng" },
        correct: "d",
        score: 10
    },
    {
        type: "choice",
        question: "Yêu cầu công nhân thực hiện EIQ cần làm gì? (10 điểm)",
        options: {
            a: "Hiểu được tầm quan trọng của EIQ đến chất lượng",
            b: "Công nhân phải nhìn - làm - và kiểm tra chất lượng",
            c: "Cán bộ thường xuyên theo dõi và kiểm tra công nhân có thực hiện hay không",
            d: "Tất cả đều đúng"
        },
        correct: "b",
        score: 10
    },
    {
        type: "choice",
        question: "Tỉ lệ RFT cao trong sản xuất thể hiện điều gì? (10 điểm)",
        options: {
            a: "Chứng minh chất lượng sản xuất trên chuyền",
            b: "Hiệu quả của việc thực hiện 3 Don’t/EIQ trên chuyền",
            c: "Hiện trường sản xuất ổn định, có vấn đề lớn",
            d: "A và B đúng"
        },
        correct: "d",
        score: 10
    },
    {
        type: "choice",
        question: "Yêu cầu về quản lí kim loại và vật dụng sắc nhọn như thế nào đúng? (10 điểm)",
        options: {
            a: "Báo biểu kim gãy: đủ mảnh, kí tên đầy đủ, bảo quản hợp lí",
            b: "Công cụ, dụng cụ sắt nhọn: phải quản lí, có đầy thông tin, cột cố định",
            c: "Không được sử dụng kim bấm, giày có kim loại phải được qua máy X-RAY",
            d: "Giày sản xuất trên chuyền phải qua máy rà kim băng tải",
            e: "Tất cả đều đúng"
        },
        correct: "e",
        score: 10
    },
    {
        type: "choice",
        question: "Yêu cầu về quản lí máy móc, thiết bị của hiện trường sản xuất nào dưới đây đúng? (10 điểm)",
        options: {
            a: "Máy định hình phải đúng dạng khuôn, size số theo SOP",
            b: "Máy hơ đế được chỉnh nhiệt độ theo từng chiếc đế bị nặng nhẹ khác nhau",
            c: "Lò sấy được chỉnh nhiệt độ, thời gian theo ảnh hưởng môi trường",
            d: "Chỉnh tốc độ băng tải để có sản lượng"
        },
        correct: "a",
        score: 10
    },
    {
        type: "choice",
        question: "Sử dụng hóa chất như thế nào là đúng nhất ? (10 điểm)",
        options: {
            a: "Hóa chất sử dụng được thay đổi tùy ý",
            b: "Hóa chất sử dụng phải có thông tin và hiển thị đúng SOP",
            c: "Hóa chất sử dụng được sử dụng liên tục, không cần thay mới",
            d: "Hóa chất sử dụng không cần tuân thủ SDS"
        },
        correct: "b",
        score: 10
    },
    {
        type: "choice",
        question: "Yêu cầu công nhân phải làm gì để tuân thủ được yêu cầu của KH QIP là gì? (10 điểm)",
        options: {
            a: "Công nhân phải ý thức chất lượng tốt, tự làm tự kiểm: nhìn – thao tác – kiểm tra",
            b: "Công nhân phải nắm được SOP công đoạn mình thực hiện, nắm tiêu chuẩn, trọng điểm thao tác",
            c: "Công nhân phải mang bao tay khi thực hiện với giày màu trắng hay màu sáng",
            d: "Tất cả đều đúng"
        },
        correct: "d",
        score: 10
    },
    {
        type: "choice",
        question: "Trách nhiệm của QC như thế nào? (10 điểm)",
        options: {
            a: "Nắm được thao tác và tiêu chuẩn chất lượng",
            b: "Kiểm soát chất lượng không được bỏ sót lỗi",
            c: "Phải thực hiện đúng quy tắc hoạt động đèn Andon",
            d: "Giày lỗi phải được ghi nhận số lượng vào báo biểu",
            e: "Tất cả đều đúng"
        },
        correct: "e",
        score: 10
    },
    {
        type: "choice",
        question: "Nhiệm vụ chính của CBHT là gì? (10 điểm)",
        options: {
            a: "Nắm được công đoạn trọng điểm, trọng điểm chất lượng, tiêu chuẩn chất lượng,….. ",
            b: "Tình hình chất lượng trên chuyền, vấn đề thường phát sinh,………",
            c: "Cập nhật báo biểu, biểu đồ xương cá,……",
            d: "Kiểm tra thiết lập máy móc, khu vực sản xuất phải tuân thủ SOP, 6S,…….",
            e: "Tất cả đều đúng"
        },
        correct: "e",
        score: 10
    }
    // {
    //     type: "text",
    //     question: "ZT02 là gì, kể tên những vấn đề gặp phải sẽ bị ZT02. (10 điểm)",
    //     keywords: ["kiểm tra", "chất lượng", "sản xuất"],  // dùng nếu chấm tự động
    //     score: 10
    // },
    // {
    //     type: "text",
    //     question: "ZT06 là gì, kể tên những vấn đề gặp phải sẽ bị ZT06. (10 điểm)",
    //     keywords: ["kiểm tra", "chất lượng", "sản xuất"],  // dùng nếu chấm tự động
    //     score: 10
    // }
];

/* ===== RENDER ===== */
const quizDiv = document.getElementById("quiz");
quizData.forEach((q,i)=>{
    let html=`<div class="question"><h3>Câu ${i+1}: ${q.question}</h3>`;
    if(q.type==="choice"){
        html+=`<div class="options">`;
        for(let k in q.options){
            html+=`<label><input type="radio" name="q${i}" value="${k}"> (${k}) ${q.options[k]}</label>`;
        }
        html+=`</div>`;
    }
    if(q.type==="text"){
    html+=`<textarea data-index="${i}" placeholder="Nhập câu trả lời..."></textarea>`;
    }
    html+=`</div>`;
    quizDiv.innerHTML+=html;
});

/* ===== SUBMIT + SCORE ===== */
function submitQuiz() {
    if (!db) {
        alert("Database chưa sẵn sàng, vui lòng thử lại");
        return;
    }
    let totalScore = 0;
    let maxScore = 0;

    quizData.forEach((q, i) => {
        maxScore += q.score;

        if (q.type === "choice") {
            const s = document.querySelector(`input[name="q${i}"]:checked`);
            if (s && s.value === q.correct) {
                totalScore += q.score;
            }
        }
        if (q.type === "text") {
            const textarea = document.querySelector(`textarea[data-index="${i}"]`);
            const answer = textarea?.value.toLowerCase().trim() || "";

            let matched = 0;
            q.keywords.forEach(k => {
                if (answer.includes(k.toLowerCase())) matched++;
            });

            const ratio = matched / q.keywords.length;

            if (ratio >= 0.8) totalScore += q.score;
            else if (ratio >= 0.5) totalScore += q.score / 2;
        }
    });

    // ===== ĐIỀN ĐIỂM + GHI CHÚ =====
    document.getElementById("scoreCell").innerText = totalScore;

    const resultCell = document.getElementById("resultCell");
    const ketQua = totalScore >= 70 ? "ĐẠT" : "KHÔNG ĐẠT";

    resultCell.innerText = ketQua;
    resultCell.style.color = totalScore >= 70 ? "green" : "red";

    // ===== LẤY THÔNG TIN NGƯỜI THI =====
    const nametest = document.getElementById("name-test")?.textContent.trim() || "QIP_TEST";
    const hoTen = document.getElementById("fullname")?.value.trim();
    const soThe = document.getElementById("empid")?.value.trim();

    if (!hoTen || !soThe) {
        alert("Vui lòng nhập Họ tên và Số thẻ");
        return;
    }

    const now = new Date();
    const timeStr = now.toLocaleString();
    const dateStr = now.toISOString().slice(0, 10);

    // ===== NỘI DUNG TXT =====
    const txtContent = `
${timeStr}
HoTen: ${hoTen}
SoThe: ${soThe}
Diem: ${totalScore} / ${maxScore}
KetQua: ${ketQua}
------------------------
`;

    // ===== LƯU INDEXEDDB =====
    const transaction = db.transaction(["results"], "readwrite");
    const store = transaction.objectStore("results");

    store.add({
        time: timeStr,
        hoTen,
        soThe,
        score: totalScore,
        ketQua,
        content: txtContent
    });

    transaction.oncomplete = () => {

        // ===== ĐẶT TÊN FILE PRINT =====
        const oldTitle = document.title;
        document.title = `${nametest}_${hoTen}_${soThe}_${timeStr}`;

        alert("Nộp bài thành công!");
        window.print();

        // phục hồi title
        document.title = oldTitle;
    };
}
</script>

</body>
</html>
